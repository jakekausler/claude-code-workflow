# Stage 5.5B: Skill Updates — Branch Chain & Draft MR — Design

## Overview

Stage 5.5B updates phase skills to consume the graduated dependency resolution infrastructure built in Stage 5.5A. It adds code host adapter methods for MR management, updates `phase-build` to merge parent branches into worktrees, updates `phase-finalize` to create draft MRs with correct branch targeting, and introduces a new `resolve-merge-conflicts` skill.

## Prerequisites

- Stage 5.5A complete on `kanban` branch (687 tests, all passing)
- `pending_merge_parents`, `is_draft`, `mr_target_branch` fields exist in frontmatter schemas, SQLite, and Stage interface
- Sync engine dual resolution (soft at PR Created, hard at Complete) is operational
- `StageRepository.updatePendingMergeParents()` method exists

---

## 1. Code Host Adapter Additions

### New Interface Methods

```typescript
interface CodeHostAdapter {
  // Existing
  getPRStatus(prUrl: string): PRStatus;

  // New in 5.5B
  editPrBase(prNumber: number, newBase: string): void;
  markPrReady(prNumber: number): void;
  getBranchHead(branch: string): string; // returns commit SHA
}
```

### GitHub Implementation (gh CLI)

| Method | Command |
|--------|---------|
| `editPrBase` | `gh pr edit <number> --base <newBase>` |
| `markPrReady` | `gh pr ready <number>` |
| `getBranchHead` | `gh api repos/{owner}/{repo}/git/ref/heads/{branch}` → extract SHA |

### GitLab Implementation (glab CLI)

| Method | Command |
|--------|---------|
| `editPrBase` | `glab mr update <number> --target-branch <newBase>` |
| `markPrReady` | `glab mr update <number> --ready` |
| `getBranchHead` | `glab api projects/:id/repository/branches/<branch>` → extract SHA |

### Error Handling

- `editPrBase` and `markPrReady` **throw on failure** — callers need to know if the mutation failed
- `getBranchHead` returns empty string on failure (safe default, same pattern as `getPRStatus`)
- All methods use the existing `execFn` injection pattern for testability

### Consumption Note

These adapter methods are consumed by Stage 6D's cron (for retargeting and promoting MRs after parent merge). Phase-finalize in 5.5B uses `gh pr create --draft` / `glab mr create --draft` directly at MR creation time. The methods are added now because they belong to the code host abstraction layer and 5.5B is the right time to build them alongside the draft MR logic.

---

## 2. `phase-build` Skill Updates — Parent Branch Merging

### New Step: Parent Branch Merge

Inserted **after worktree setup, before planning**:

1. Read `pending_merge_parents` from stage YAML frontmatter
2. If empty array or not present → skip this section entirely
3. For each parent in `pending_merge_parents`:
   a. `git fetch origin`
   b. `git merge origin/<parent.branch> --no-edit`
   c. If merge conflicts → invoke `resolve-merge-conflicts` skill
4. After all parents merged: run full `npm run verify` (or project equivalent)
5. If verify fails:
   a. Analyze failures using full codebase + parent/child stage context
   b. Fix issues (type errors, test failures, lint issues from merge integration)
   c. Re-run verify
   d. Repeat until passing or until the direction is genuinely ambiguous (e.g., two patterns with opposite intentions, no clear path)
   e. Only escalate to user if the correct direction cannot be determined from context
6. Proceed to planning phase with clean, verified, merged baseline

### Key Behaviors

- Fetch happens once per parent — simple and correct even with multiple parents referencing different remote states
- `--no-edit` avoids interactive commit message editing
- `resolve-merge-conflicts` skill runs in the same session with full context (not a subagent)
- Full verification runs after **all** parents are merged (not after each individual merge)
- The session exhausts its own problem-solving ability before escalating to the user

### What phase-build Does NOT Do

- Does not set `is_draft` or `mr_target_branch` — phase-finalize's job
- Does not modify `pending_merge_parents` — sync engine's job
- Does not push anything — build phase works locally in the worktree

---

## 3. `resolve-merge-conflicts` Skill

New skill created in this stage. Invoked from `phase-build` during parent branch merges. Will also be reused by Stage 6D's `rebase-child-mr` skill.

### Trigger

Invoked when `git merge` or `git rebase` results in conflicts.

### Inputs

- Conflicting files (from `git diff --name-only --diff-filter=U`)
- Current stage's design doc, build notes, and YAML frontmatter
- Parent stage's design doc, build notes, and YAML frontmatter
- Full codebase context in the worktree

### Flow

```
1. Identify all conflicting files: `git diff --name-only --diff-filter=U`

1.5. Auto-resolve trivially conflicting files:
   - package-lock.json / yarn.lock / pnpm-lock.yaml
     → accept current branch version, then run `npm install` (or equivalent) to regenerate
   - *.generated.ts, *.generated.graphql
     → accept current, regenerate via project tooling
   - .gitignore, .prettierrc, tsconfig.json
     → merge both entries, deduplicate
   - Any file that is purely additive on both sides (e.g., changelog)
     → concatenate entries
   - `git add <file>` for each auto-resolved file

2. For each remaining conflicting file:
   a. Read the file with conflict markers
   b. Read the parent stage's design doc and build notes for intent context
   c. Read the current stage's design doc for intent context
   d. Analyze both sides of each conflict (see resolution heuristics)
   e. Resolve the conflict (replace conflict markers with resolution)
   f. `git add <file>` to mark as resolved

3. After all files resolved:
   - `git merge --continue` (if called during merge)
   - `git rebase --continue` (if called during rebase)

4. Return control to caller
```

### Resolution Heuristics (Priority Order)

1. **Complementary changes** — both sides add different things → keep both, order logically
2. **Superset** — one side includes the other's changes plus more → keep the superset
3. **Import/export conflicts** — merge both import lists, deduplicate
4. **Type definition conflicts** — merge both sets of fields/methods
5. **Logic conflicts** — read stage design docs to determine which behavior is intended; the child stage's intent generally takes precedence since the parent's work is already "done" (in PR)
6. **Genuinely ambiguous** — two opposing patterns, no contextual signal → escalate to user via AskUserQuestion

### What This Skill Does NOT Do

- Does not run verification — caller's responsibility
- Does not modify stage frontmatter or tracking files
- Does not make architectural decisions — resolves merge mechanics

### Stage 6D Reuse Note

The `rebase-child-mr` skill (Stage 6D) will invoke this same skill when rebasing child branches after parent MR merge. The skill handles both `git merge` conflicts (step 3: `--continue`) and `git rebase` conflicts (step 3: `--continue`). Stage 6D should invoke this skill identically — the only difference is whether the caller ran `git merge` or `git rebase` before hitting conflicts.

---

## 4. `phase-finalize` Skill Updates — Draft MR Creation

### Target Branch Logic

Before creating the MR, determine the target branch:

1. Read `pending_merge_parents` from stage YAML frontmatter
2. Filter to only unmerged parents:
   - Check parent stage status via reading parent YAML (is it "Complete"?)
   - Or check parent's PR merge status via `gh pr view` / `glab mr view`
   - Remove any that are already merged
3. Determine target:
   - **Zero unmerged parents** → default branch (main/master)
   - **Exactly one unmerged parent** → that parent's MR branch (`parent.branch`)
   - **Multiple unmerged parents** → default branch (main/master)
4. Determine draft status:
   - **Any unmerged parents** → create as draft
   - **Zero unmerged parents** → create as ready (normal)

### MR Creation Commands

```bash
# GitHub (draft, targeting parent branch)
gh pr create --base <target_branch> --draft --title "..." --body "..."

# GitHub (ready, targeting default branch)
gh pr create --base <target_branch> --title "..." --body "..."

# GitLab (draft, targeting parent branch)
glab mr create --target-branch <target_branch> --draft --title "..." --description "..."

# GitLab (ready, targeting default branch)
glab mr create --target-branch <target_branch> --title "..." --description "..."
```

### MR Description — Dependencies Section

If there are unmerged parents, append to the MR body:

```markdown
## Dependencies

This MR depends on the following unmerged parent MRs:

- **STAGE-001-001-001**: [feature/auth](https://github.com/org/repo/pull/42)
- **STAGE-001-001-002**: [feature/db-schema](https://github.com/org/repo/pull/43)

⚠️ This MR was created as a **draft** because parent dependencies are not yet merged.
```

If zero unmerged parents — no Dependencies section. Merged parents are omitted entirely.

### Frontmatter Updates

After MR creation, update stage YAML:
- `is_draft: true` (if created as draft)
- `mr_target_branch: <target_branch>`
- `pr_url` and `pr_number` (already handled by existing finalize logic)

### What phase-finalize Does NOT Do

- Does not call `editPrBase` or `markPrReady` — those are for Stage 6D's cron
- Does not modify `pending_merge_parents` — sync engine's job
- Does not handle rebase — Stage 6D's `rebase-child-mr`

---

## 5. Testing Strategy

### Code Host Adapter Tests (Unit Tests)

Same pattern as existing `getPRStatus` tests — inject `execFn`, verify CLI arguments and response parsing.

**`editPrBase` tests:**
- Constructs correct CLI command for GitHub and GitLab
- Throws on CLI failure

**`markPrReady` tests:**
- Constructs correct CLI command for GitHub and GitLab
- Throws on CLI failure

**`getBranchHead` tests:**
- Constructs correct API call for GitHub and GitLab
- Extracts SHA from JSON response
- Returns empty string on failure

**Interface compliance tests:**
- Both adapters implement all new methods on `CodeHostAdapter`

### Skill Files

The skill updates (phase-build, phase-finalize, resolve-merge-conflicts) are Markdown instruction files. Correctness is validated by:
1. Code review of the instructions
2. This design doc specifying expected behavior
3. Execution during actual stage workflows

### Not Tested

- End-to-end draft MR creation with correct target branch (requires real git remote)
- Conflict resolution quality (heuristics, not deterministic logic)
- Parent branch merge flow (orchestrated by skill, not testable code)

---

## Summary of Deliverables

| Deliverable | Type | Files |
|-------------|------|-------|
| `editPrBase` adapter method | TypeScript | adapters/types.ts, github-adapter.ts, gitlab-adapter.ts |
| `markPrReady` adapter method | TypeScript | adapters/types.ts, github-adapter.ts, gitlab-adapter.ts |
| `getBranchHead` adapter method | TypeScript | adapters/types.ts, github-adapter.ts, gitlab-adapter.ts |
| Adapter unit tests | TypeScript | test files for github/gitlab adapters |
| `phase-build` parent merge step | Skill (Markdown) | skills/phase-build/SKILL.md |
| `phase-finalize` draft MR logic | Skill (Markdown) | skills/phase-finalize/SKILL.md |
| `resolve-merge-conflicts` skill | Skill (Markdown) | skills/resolve-merge-conflicts/SKILL.md |

## Stage 6D Forward Notes

The following items from this design are consumed or extended by Stage 6D:

- **`editPrBase`**: Called by cron to retarget child MRs after parent merge (single parent → main, or multi-parent → remaining parent)
- **`markPrReady`**: Called by cron to promote draft → ready after all parents merged and rebase clean
- **`getBranchHead`**: Called by cron to detect parent branch updates (compare against `last_known_head` in `parent_branch_tracking`)
- **`resolve-merge-conflicts` skill**: Invoked by `rebase-child-mr` skill when rebasing child branches after parent merge. Same skill, same flow — only difference is `git rebase --continue` instead of `git merge --continue`
- **`parent_branch_tracking` table**: Schema exists (5.5A), population is 6D's responsibility
